<pre>
  BIP: 276
  Layer: Applications
  Title: New Scheme for BIP-0032 Extended Key Encoding
  Author: Curtis Ellis <curtis.ellis@tokenized.com>
  Status: Draft
  Type: Standards Track
  Created: 2019-10-29
  License: PD
</pre>

==Abstract==

This BIP proposes upgrading the [[/bip-0032.mediawiki|BIP-0032]] scheme for encoding extended keys
in a user and backend friendly way. The main purpose is to add multi-key values and drop base58
encoding for hex to be compliant with [[/bip-0276.mediawiki|BIP-0276]].

==Motivation==

[[/bip-0032.mediawiki|BIP-0032]] provides functionality for deriving hierarchal keys and encoding
them. With [[/bip-0276.mediawiki|BIP-0276]] and multi-sig functionality its encoding is now somewhat
outdated.

Previously xpubs were expected to be handled by users and possibly even written down or typed. In
the near future, with well designed UX, that should not happen. Occasionally users may need to
copy/paste or scan extended keys and even sets of extended keys for multi-sig solutions. Because of
this base 58 encoding is no longer needed.

With multi-sig scenarios there is a need to store and transmit multiple xpubs (extended public keys)
together so that new multi-sig addresses can be generated by all parties. To facilitate this, the
BIP32 key encoding needs to be extended to support multi-key formats. With that ability single key
and multi-sig can be more coherent processes.

Therefore, we now need a way to encode extended keys that allows specifying more than one, removes
base58 complexity in exchange for simple hex, and attempts to further simplify the encoding.

==Specification==

The [[/bip-0276.mediawiki|BIP-0276]] scheme follows this form:

 <nowiki><prefix>:<version hex><network hex><data hex><checksum hex></nowiki>

The <code>prefix</code> for the [[/bip-0276.mediawiki|BIP-0276]] scheme for this specification is
<code>bitcoin-xkey</code> or <code>bitcoin-xkeys</code> where xkey is short for extended key. Since
it no longer specifies public or private the user interface should make it clear. Private keys
should be rare and very clearly identified in the user interface. The first byte of the
<code>Key</code> value within an xkey specifies whether each key is public or private so it is now
possible to mix them if needed.


The <code>data</code> contained in the [[/bip-0276.mediawiki|BIP-0276]] scheme for this
specification is as follows:

{| class="wikitable"
| '''Header Byte'''
! style="text-align: center;" | 1 byte
| <code>0x40</code> signifying a single xkey value or <code>0x41</code> signifying multiple xkey
values. This is redundant, but useful for internal encodings that only contain the raw data.
<code>0x40</code> is only valid with the prefix <code>bitcoin-xkey</code> and <code>0x41</code> is
only valid with the prefix <code>bitcoin-xkeys</code>.
|-
| '''XKey Count'''
! style="text-align: center;" | [//developers.google.com/protocol-buffers/docs/encoding#varints Base 128 Varint]
| If the header byte is <code>0x40</code> then this value is not included or serialized. If the
header byte is <code>0x41</code> this is a count of how many xkeys follow.
Note: Base 128 var int values less than 128 are equivalent to a single byte integer.
|-
| '''XKey List'''
! style="text-align: center;" | List of XKeys
| XKey values concatenated together.
|}

Where each XKey value consists of the following:

{| class="wikitable"
| '''Depth'''
! style="text-align: center;" | 1 byte (8 bit integer)
| Depth of key from master/root
|-
| '''Fingerprint'''
! style="text-align: center;" | 4 bytes
| First 4 bytes of RIPEMD160(SHA256(Parent Public Key))
|-
| '''Index'''
! style="text-align: center;" | 4 bytes (32 bit integer)
| 32 bit integer representing index of child within parent. Values equal or greater than 0x80000000 are “hardened”.
|-
| '''Chain Code'''
! style="text-align: center;" | 32 bytes
| 32 byte value used to generate children
|-
| '''Key'''
! style="text-align: center;" | 33 bytes
| 32 byte key value with leading type byte.
0x00 private, 0x02 or 0x03 for compressed public.
|}

So an individually encoded extended public key looks like this.
<img src=bip-0278/xkey_diagram.png></img>

And a set of encoded extended public keys looks like this.
<img src=bip-0278/xkeys_diagram.png></img>


==Copyright==

This document is placed in the public domain.
